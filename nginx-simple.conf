server{
    server_name consejo.geroserial.com;

    # Configuración básica
    client_max_body_size 10m;
    
    # Compression ligera
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types text/plain text/css application/json application/javascript text/javascript;

    # Solo cachear assets estáticos inmutables de Next.js
    location /_next/static/ {
        proxy_pass http://localhost:3000;
        proxy_cache STATICCACHE;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "public, immutable, max-age=31536000";
        add_header X-Cache-Status "$upstream_cache_status" always;
        expires 1y;
    }

    # Cache inteligente: ignorar headers restrictivos de Next.js y aplicar cache corto
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # IGNORAR los headers restrictivos de Next.js
        proxy_ignore_headers Cache-Control Expires Set-Cookie Vary;
        
        # Cache corto para proteger contra picos de tráfico
        proxy_cache STATICCACHE;
        proxy_cache_key "$scheme$request_method$host$request_uri$args";
        proxy_cache_valid 200 5s;  # Solo 5 segundos
        
        # Servir contenido obsoleto si Next.js está ocupado
        proxy_cache_use_stale updating error timeout http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 2s;
        
        # Headers de debugging
        add_header X-Cache-Status "$upstream_cache_status" always;
        add_header X-Cache-TTL "5s" always;
    }

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/consejo.geroserial.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/consejo.geroserial.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = consejo.geroserial.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name consejo.geroserial.com;
    return 404; # managed by Certbot
}
